let currentFile = null;

document.getElementById('videoFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        validateAndSetFile(file);
    }
});

function validateAndSetFile(file) {
    // Check file type
    if (!file.type.includes('mp4')) {
        alert('Please upload only MP4 files');
        return;
    }

    // Check file size (200MB)
    const maxSize = 200 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('File size must be less than 200MB');
        return;
    }

    currentFile = file;
    
    // Update UI
    document.getElementById('fileName').textContent = `Name: ${file.name}`;
    document.getElementById('fileSize').textContent = `Size: ${(file.size / (1024 * 1024)).toFixed(2)} MB`;
    document.getElementById('fileInfo').style.display = 'block';
    
    // Enable buttons
    document.getElementById('transcribeBtn').disabled = false;
    document.getElementById('summarizeBtn').disabled = false;
    
    // Update upload box
    document.getElementById('uploadBox').style.borderColor = '#4CAF50';
    document.getElementById('uploadBox').style.backgroundColor = '#f0fff0';
}

function processVideo(action) {
    if (!currentFile) {
        alert('Please select a video file first');
        return;
    }

    const language = document.getElementById('language').value;
    const formData = new FormData();
    formData.append('video', currentFile);
    formData.append('language', language);
    formData.append('action', action);

    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';

    fetch(`/${action}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading').style.display = 'none';
        
        if (data.success) {
            displayResults(data, action);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        console.error('Error:', error);
        alert('An error occurred while processing the video');
    });
}

function displayResults(data, action) {
    const resultContent = document.getElementById('resultContent');
    const downloadBtn = document.getElementById('downloadBtn');
    
    if (action === 'transcribe') {
        resultContent.innerHTML = `
            <div class="transcription-result">
                <h4>üé§ Transcription Results</h4>
                <div class="language-section">
                    <h5>English (Original):</h5>
                    <div class="text-content">${data.transcription_english}</div>
                </div>
                <div class="language-section">
                    <h5>${data.language}:</h5>
                    <div class="text-content">${data.transcription_target}</div>
                </div>
                <div class="stats">
                    <small>Original: ${data.original_length} characters | Translated: ${data.translated_length} characters</small>
                </div>
            </div>
        `;
    } else {
        resultContent.innerHTML = `
            <div class="summary-result">
                <h4>üìù Summary Results</h4>
                <div class="language-section">
                    <h5>English Summary:</h5>
                    <div class="text-content">${data.summary_english}</div>
                </div>
                <div class="language-section">
                    <h5>${data.language} Summary:</h5>
                    <div class="text-content">${data.summary_target}</div>
                </div>
                <div class="stats">
                    <small>Original text: ${data.original_text_length} characters | Summary: ${data.summary_length} characters</small>
                </div>
            </div>
        `;
    }
    
    // Store data for download
    const content = action === 'transcribe' ? 
        `ENGLISH TRANSCRIPTION:\n${data.transcription_english}\n\n${data.language.toUpperCase()} TRANSCRIPTION:\n${data.transcription_target}\n\nGenerated by Video Summarizer Tool` :
        `ENGLISH SUMMARY:\n${data.summary_english}\n\n${data.language.toUpperCase()} SUMMARY:\n${data.summary_target}\n\nGenerated by Video Summarizer Tool`;
    
    downloadBtn.setAttribute('data-content', content);
    downloadBtn.setAttribute('data-filename', `${action}_results_${data.language}.txt`);
    downloadBtn.style.display = 'block';
    
    document.getElementById('resultsSection').style.display = 'block';
    
    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function downloadResult() {
    const content = document.getElementById('downloadBtn').getAttribute('data-content');
    const filename = document.getElementById('downloadBtn').getAttribute('data-filename');
    
    const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Drag and drop functionality
const uploadBox = document.getElementById('uploadBox');

uploadBox.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadBox.style.borderColor = '#764ba2';
    uploadBox.style.backgroundColor = '#f0f0ff';
});

uploadBox.addEventListener('dragleave', () => {
    uploadBox.style.borderColor = '#667eea';
    uploadBox.style.backgroundColor = '';
});

uploadBox.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadBox.style.borderColor = '#667eea';
    uploadBox.style.backgroundColor = '';
    
    const file = e.dataTransfer.files[0];
    if (file) {
        validateAndSetFile(file);
        // Update file input
        const dt = new DataTransfer();
        dt.items.add(file);
        document.getElementById('videoFile').files = dt.files;
    }
});

// Add some CSS for better text display
const style = document.createElement('style');
style.textContent = `
    .text-content {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border-left: 3px solid #667eea;
        line-height: 1.6;
        max-height: 300px;
        overflow-y: auto;
        margin: 10px 0;
    }
    .language-section {
        margin-bottom: 20px;
    }
    .language-section h5 {
        color: #333;
        margin-bottom: 8px;
        font-size: 16px;
    }
    .stats {
        text-align: center;
        color: #666;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #ddd;
    }
`;
document.head.appendChild(style);